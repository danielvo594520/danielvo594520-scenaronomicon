name: Create Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼ˆä¾‹: 1.1.0ï¼‰'
        required: true
        type: string
      build_apk:
        description: 'APKã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦ãƒªãƒªãƒ¼ã‚¹ã«æ·»ä»˜ã™ã‚‹'
        required: false
        type: boolean
        default: true
      prerelease:
        description: 'ãƒ—ãƒ¬ãƒªãƒªãƒ¼ã‚¹ã¨ã—ã¦ãƒãƒ¼ã‚¯ã™ã‚‹'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  create-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate version format
        run: |
          VERSION="${{ github.event.inputs.version }}"
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::ãƒãƒ¼ã‚¸ãƒ§ãƒ³å½¢å¼ãŒä¸æ­£ã§ã™ã€‚X.Y.Z å½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹: 1.0.0ï¼‰"
            exit 1
          fi
          echo "VERSION=v${VERSION}" >> $GITHUB_ENV
          echo "VERSION_NUMBER=${VERSION}" >> $GITHUB_ENV

      - name: Check tag does not exist
        run: |
          if git rev-parse "${{ env.VERSION }}" >/dev/null 2>&1; then
            echo "::error::ã‚¿ã‚° ${{ env.VERSION }} ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™"
            exit 1
          fi

      - name: Update version in source files
        run: |
          VERSION="${{ env.VERSION_NUMBER }}"

          # pubspec.yaml ã®ãƒ“ãƒ«ãƒ‰ç•ªå·ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
          CURRENT_BUILD=$(grep -oP '(?<=\+)\d+' pubspec.yaml)
          NEW_BUILD=$((CURRENT_BUILD + 1))

          # pubspec.yaml ã‚’æ›´æ–°
          sed -i "s/^version: .*/version: ${VERSION}+${NEW_BUILD}/" pubspec.yaml

          # app_constants.dart ã‚’æ›´æ–°
          sed -i "s/static const String appVersion = '.*'/static const String appVersion = '${VERSION}'/" \
            lib/core/constants/app_constants.dart

          echo "BUILD_NUMBER=${NEW_BUILD}" >> $GITHUB_ENV
          echo "::notice::ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ ${VERSION}+${NEW_BUILD} ã«æ›´æ–°ã—ã¾ã—ãŸ"

      - name: Commit version update
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add pubspec.yaml lib/core/constants/app_constants.dart
          git commit -m "chore: ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ ${{ env.VERSION_NUMBER }} ã«æ›´æ–°"
          git push origin HEAD:main

      - name: Generate release notes
        id: release_notes
        run: |
          # ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ›´æ–°ã‚³ãƒŸãƒƒãƒˆã®1ã¤å‰ã‹ã‚‰ã€å‰å›ã‚¿ã‚°ã¾ã§ã®å¤‰æ›´å±¥æ­´ã‚’å–å¾—
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")
          if [ -z "$PREVIOUS_TAG" ]; then
            COMMITS=$(git log --oneline --no-merges HEAD~1 | head -50)
          else
            COMMITS=$(git log --oneline --no-merges "${PREVIOUS_TAG}..HEAD~1" | head -50)
          fi

          {
            echo "notes<<EOF"
            echo "## Scenaronimicon ${{ env.VERSION }}"
            echo ""

            # ã‚«ãƒ†ã‚´ãƒªåˆ¥ã«åˆ†é¡
            FEATS=$(echo "$COMMITS" | grep -E "^[a-f0-9]+ feat:" | sed 's/^[a-f0-9]* feat: //' || true)
            FIXES=$(echo "$COMMITS" | grep -E "^[a-f0-9]+ fix:" | sed 's/^[a-f0-9]* fix: //' || true)
            DOCS=$(echo "$COMMITS" | grep -E "^[a-f0-9]+ docs:" | sed 's/^[a-f0-9]* docs: //' || true)
            OTHERS=$(echo "$COMMITS" | grep -vE "^[a-f0-9]+ (feat|fix|docs|chore|ci):" | sed 's/^[a-f0-9]* //' || true)

            if [ -n "$FEATS" ]; then
              echo "### ğŸ†• æ–°æ©Ÿèƒ½"
              echo "$FEATS" | while IFS= read -r line; do [ -n "$line" ] && echo "- ${line}"; done
              echo ""
            fi

            if [ -n "$FIXES" ]; then
              echo "### ğŸ› ãƒã‚°ä¿®æ­£"
              echo "$FIXES" | while IFS= read -r line; do [ -n "$line" ] && echo "- ${line}"; done
              echo ""
            fi

            if [ -n "$DOCS" ]; then
              echo "### ğŸ“ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ"
              echo "$DOCS" | while IFS= read -r line; do [ -n "$line" ] && echo "- ${line}"; done
              echo ""
            fi

            if [ -n "$OTHERS" ]; then
              echo "### ğŸ“¦ ãã®ä»–"
              echo "$OTHERS" | while IFS= read -r line; do [ -n "$line" ] && echo "- ${line}"; done
              echo ""
            fi

            echo "---"
            echo "Built from commit: $(git rev-parse HEAD)"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Setup Flutter
        if: ${{ github.event.inputs.build_apk == 'true' }}
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true

      - name: Install dependencies
        if: ${{ github.event.inputs.build_apk == 'true' }}
        run: flutter pub get

      - name: Run code generation
        if: ${{ github.event.inputs.build_apk == 'true' }}
        run: flutter pub run build_runner build --delete-conflicting-outputs

      - name: Build APK
        if: ${{ github.event.inputs.build_apk == 'true' }}
        run: flutter build apk --release

      - name: Rename APK
        if: ${{ github.event.inputs.build_apk == 'true' }}
        run: |
          mv build/app/outputs/flutter-apk/app-release.apk \
             build/app/outputs/flutter-apk/scenaronimicon-${{ env.VERSION }}.apk

      - name: Create tag and release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.VERSION }}
          name: ${{ env.VERSION }}
          body: ${{ steps.release_notes.outputs.notes }}
          target_commitish: main
          prerelease: ${{ github.event.inputs.prerelease == 'true' }}
          files: |
            ${{ github.event.inputs.build_apk == 'true' && format('build/app/outputs/flutter-apk/scenaronimicon-{0}.apk', env.VERSION) || '' }}
          generate_release_notes: false
